---
title: "Distribución Binomial Negativa"
lang: es
---

```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(knitr)
library(gridExtra)
library(plotly)
```

La **distribución binomial negativa** modela el número de fracasos que ocurren antes de obtener exactamente $r$ éxitos en una secuencia de ensayos independientes de Bernoulli, donde cada ensayo tiene una probabilidad constante $p$ de éxito.

::: {#def-binom_neg}
Si $X$ es una variable aleatoria que sigue una distribución binomial negativa, entonces $X$ representa el número de fracasos antes de obtener el $r$-ésimo éxito. La función probabilidad está dada por:

$$f(x) = \binom{r + x - 1}{x} p^r (1-p)^x$$

donde $x = 0, 1, 2, 3, \ldots$ representa el número de fracasos. Una variable aleatoria con esta distribución se denota como: $X \sim \text{BinNeg}(r, p)$
:::

## Características

**Parámetros**

La distribución binomial negativa tiene dos parámetros:

-   $r$: Número de éxitos deseados (entero positivo, $r \geq 1$)
-   $p$: Probabilidad de éxito en cada ensayo ($0 < p \leq 1$)

**Parámetros Estadísticos**

Media (Esperanza):

$$E(X) = \frac{r(1-p)}{p}$$

Varianza:

$$\text{Var}(X) = \frac{r(1-p)}{p^2}$$

Desviación estándar:

$$\sigma = \sqrt{\frac{r(1-p)}{p^2}}$$

**Función de Distribución (Probabilidad Acumulada):**

$$F(x) = P(X \leq x) = \sum_{i=0}^{x} \binom{r + i - 1}{i} p^r (1-p)^i$$

## Ejemplo Básico

Un estudiante está practicando tiros libres de baloncesto. Su probabilidad de anotar es $p = 0.6$. ¿Cuál es la probabilidad de que falle exactamente 3 tiros antes de anotar su segundo tiro libre?

**Parámetros:**

-   $r = 2$ (queremos el segundo éxito)
-   $p = 0.6$ (probabilidad de éxito)
-   $k = 3$ (número de fracasos)

**Cálculo:**

```{r ejemplo-basico}
# Parámetros
r <- 2
p <- 0.6
k <- 3

# Cálculo de la probabilidad
prob <- choose(k + r - 1, k) * (p^r) * ((1-p)^k)
cat("P(X = 3) =", round(prob, 4))

# Verificación usando R
prob_r <- dnbinom(k, size = r, prob = p)
cat("\nVerificación con R:", round(prob_r, 4))
```

**Interpretación:** La probabilidad de fallar exactamente 3 tiros antes de anotar el segundo tiro libre es aproximadamente `r round(prob, 4)`.

**Parámetros estadísticos del ejemplo**

```{r parametros-ejemplo}
# Media
media <- r * (1 - p) / p
cat("Media:", round(media, 4))

# Varianza
varianza <- r * (1 - p) / (p^2)
cat("\nVarianza:", round(varianza, 4))

# Desviación estándar
desv_std <- sqrt(varianza)
cat("\nDesviación estándar:", round(desv_std, 4))
```

## Comparación: Efecto de los Parámetros

### Efecto del parámetro $r$ (número de éxitos)

```{r efecto-r, fig.cap="Efecto del parámetro r en la distribución binomial negativa"}
# Valores de k para graficar
k_vals <- 0:20

# Diferentes valores de r, p fijo
r_values <- c(1, 2, 5, 10)
p_fixed <- 0.4

# Crear data frame para ggplot
data_r <- expand.grid(k = k_vals, r = r_values)
data_r$p <- p_fixed
data_r$prob <- dnbinom(data_r$k, size = data_r$r, prob = data_r$p)
data_r$r <- factor(data_r$r, labels = paste("r =", r_values))

# Gráfico
plot_r <- ggplot(data_r, aes(x = k, y = prob, fill = r)) +
  geom_col(position = "dodge", alpha = 0.7) +
  scale_x_continuous(breaks = k_vals) +
  labs(title = "Efecto del parámetro r (p = 0.4 fijo)",
       x = "Número de fracasos (k)",
       y = "Probabilidad",
       fill = "Parámetro r") +
  theme_minimal() +
  scale_fill_brewer(type = "qual", palette = "Set1")

ggplotly(plot_r)
```

### Efecto del parámetro $p$ (probabilidad de éxito)

```{r efecto-p, fig.cap="Efecto del parámetro p en la distribución binomial negativa"}
# Diferentes valores de p, r fijo
p_values <- c(0.2, 0.4, 0.6, 0.8)
r_fixed <- 3

# Crear data frame para ggplot
data_p <- expand.grid(k = k_vals, p = p_values)
data_p$r <- r_fixed
data_p$prob <- dnbinom(data_p$k, size = data_p$r, prob = data_p$p)
data_p$p <- factor(data_p$p, labels = paste("p =", p_values))

# Gráfico
plot_p <- ggplot(data_p, aes(x = k, y = prob, fill = p)) +
  geom_col(position = "dodge", alpha = 0.7) +
  scale_x_continuous(breaks = k_vals) +
  labs(title = "Efecto del parámetro p (r = 3 fijo)",
       x = "Número de fracasos (k)",
       y = "Probabilidad",
       fill = "Parámetro p") +
  theme_minimal() +
  scale_fill_brewer(type = "qual", palette = "Set2")

 ggplotly(plot_p)
```

### Tabla comparativa de parámetros estadísticos

```{r tabla-comparativa}
# Crear tabla con diferentes combinaciones de parámetros
combinaciones <- expand.grid(
  r = c(2, 5, 10),
  p = c(0.3, 0.5, 0.7)
)

combinaciones$Media <- combinaciones$r * (1 - combinaciones$p) / combinaciones$p
combinaciones$Varianza <- combinaciones$r * (1 - combinaciones$p) / (combinaciones$p^2)
combinaciones$Desv_Std <- sqrt(combinaciones$Varianza)

# Redondear para mejor presentación
combinaciones[3:5] <- round(combinaciones[3:5], 3)

kable(combinaciones, 
      caption = "Parámetros estadísticos para diferentes valores de r y p",
      col.names = c("r", "p", "Media", "Varianza", "Desv. Estándar"))
```

### Observaciones sobre el efecto de los parámetros

**Efecto de** $r$:

-   Al aumentar $r$, la distribución se desplaza hacia la derecha (mayor media)
-   La variabilidad también aumenta
-   Para $r = 1$, se obtiene la distribución geométrica

**Efecto de** $p$:

-   Al aumentar $p$ (mayor probabilidad de éxito), la distribución se concentra más cerca de cero
-   La media y varianza disminuyen cuando $p$ aumenta

## Simulación de Valores y Comparación con la Teórica

Consideremos una variable aleatoria $X \sim \text{BinNeg}(r=5, p=0.3)$. Simularemos 10,000 valores y compararemos las estadísticas obtenidas con las teóricas.

```{r simulacion-basica}
# Parámetros para la simulación
r <- 5
p <- 0.3
n_sim <- 10000

# Simulación de valores
set.seed(422)
valores_simulados <- rnbinom(n_sim, size = r, prob = p)

# Estadísticas de la simulación
media_sim <- mean(valores_simulados)
var_sim <- var(valores_simulados)
sd_sim <- sd(valores_simulados)

# Valores teóricos
media_teorica <- r * (1 - p) / p
var_teorica <- r * (1 - p) / (p^2)
sd_teorica <- sqrt(var_teorica)

# Tabla comparativa
comparacion <- data.frame(
  Estadística = c("Media", "Varianza", "Desv. Estándar"),
  Teórica = c(media_teorica, var_teorica, sd_teorica),
  Simulada = c(media_sim, var_sim, sd_sim),
  Diferencia = c(abs(media_teorica - media_sim), 
                 abs(var_teorica - var_sim), 
                 abs(sd_teorica - sd_sim))
)

kable(comparacion, digits = 4, 
      caption = paste("Comparación teórica vs simulada (r =", r, ", p =", p, ")"))
```

**Visualización**

```{r grafico-comparacion, fig.cap="Comparación entre distribución teórica y simulada"}
# Rango de valores para comparar
k_max <- quantile(valores_simulados, 0.99)
k_vals <- 0:k_max

# Probabilidades teóricas
prob_teorica <- dnbinom(k_vals, size = r, prob = p)

# Frecuencias relativas de la simulación
freq_simulada <- table(factor(valores_simulados, levels = k_vals))
freq_relativa <- as.numeric(freq_simulada) / n_sim

# Crear data frame para ggplot
data_comp <- data.frame(
  k = rep(k_vals, 2),
  Probabilidad = c(prob_teorica, freq_relativa),
  Tipo = rep(c("Teórica", "Simulada"), each = length(k_vals))
)

# Gráfico de barras comparativo
ggplot(data_comp, aes(x = k, y = Probabilidad, fill = Tipo)) +
  geom_col(position = "dodge", alpha = 0.7, width = 0.8) +
  labs(title = paste("Distribución Binomial Negativa: Teórica vs Simulada"),
       subtitle = paste("r =", r, ", p =", p, ", n =", format(n_sim, big.mark = ",")),
       x = "Número de fracasos (k)",
       y = "Probabilidad / Frecuencia relativa",
       fill = "Distribución") +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_fill_manual(values = c("Teórica" = "#2E86C1", "Simulada" = "#E74C3C")) 
```

**Convergencia de la Simulación**

```{r convergencia, fig.cap="Convergencia de la media simulada hacia la teórica"}
# Diferentes tamaños de muestra
tamaños <- seq(100, 10000, by = 100)
medias_acumuladas <- sapply(tamaños, function(n) mean(valores_simulados[1:n]))

# Data frame para el gráfico
data_conv <- data.frame(
  n = tamaños,
  Media_simulada = medias_acumuladas,
  Media_teorica = media_teorica
)

# Gráfico de convergencia
ggplot(data_conv) +
  geom_line(aes(x = n, y = Media_simulada), color = "#E74C3C", linewidth = 1) +
  geom_hline(yintercept = media_teorica, color = "#2E86C1", 
             linetype = "dashed", linewidth = 1.2) +
  labs(title = "Convergencia de la Media Simulada",
       subtitle = paste("Línea azul: Media teórica =", round(media_teorica, 3)),
       x = "Tamaño de muestra",
       y = "Media") +
  theme_minimal() +
  annotate("text", x = 7500, y = media_teorica + 0.3, 
           label = paste("Media teórica:", round(media_teorica, 3)), 
           color = "#2E86C1")
```

## Comparación entre Binomial Negativa y Geométrica

### Relación Teórica

La distribución geométrica es un caso especial de la binomial negativa cuando $r = 1$. Ambas modelan el número de fracasos antes de obtener éxitos, pero:

-   **Geométrica:** Número de fracasos antes del **primer** éxito
-   **Binomial Negativa:** Número de fracasos antes del **r-ésimo** éxito

### Comparación Matemática

```{r comparacion-matematica}
# Parámetros
p_comp <- 0.4
r_values <- c(1, 2, 5, 10)  # r = 1 corresponde a la geométrica

# Calcular parámetros estadísticos
comp_params <- data.frame(
  r = r_values,
  Media = r_values * (1 - p_comp) / p_comp,
  Varianza = r_values * (1 - p_comp) / (p_comp^2),
  Desv_Std = sqrt(r_values * (1 - p_comp) / (p_comp^2))
)

comp_params$Es_Geometrica <- ifelse(comp_params$r == 1, "Sí", "No")

kable(comp_params, digits = 3,
      caption = paste("Parámetros estadísticos para diferentes valores de r (p =", p_comp, ")"),
      col.names = c("r", "Media", "Varianza", "Desv. Estándar", "¿Geométrica?"))
```

### Comparación Gráfica

```{r grafico-geometrica-vs-binomial, fig.cap="Comparación entre distribución geométrica y binomial negativa"}
# Valores de k para graficar
k_vals <- 0:15

# Crear data frame con las distribuciones
data_dist <- expand.grid(k = k_vals, r = c(1, 2, 3, 5))
data_dist$p <- p_comp
data_dist$Probabilidad <- dnbinom(data_dist$k, size = data_dist$r, prob = data_dist$p)
data_dist$Distribucion <- ifelse(data_dist$r == 1, "Geométrica (r=1)", 
                                paste("Binomial Neg. (r=", data_dist$r, ")", sep=""))

# Gráfico
ggplot(data_dist, aes(x = k, y = Probabilidad, fill = Distribucion)) +
  geom_col(alpha = 0.7) +
  facet_wrap(~Distribucion, scales = "free_y") +
  labs(title = "Comparación: Geométrica vs Binomial Negativa",
       subtitle = paste("p =", p_comp),
       x = "Número de fracasos (k)",
       y = "Probabilidad") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(type = "qual", palette = "Set3")
```

### Verificación mediante Simulación

```{r simulacion-comparacion}
n_sim_comp <- 5000
p_sim <- 0.35

# Simulación de geométrica (r = 1)
geometrica_sim <- rnbinom(n_sim_comp, size = 1, prob = p_sim)

# Simulación de binomial negativa (r = 3)
binneg_sim <- rnbinom(n_sim_comp, size = 3, prob = p_sim)

# Estadísticas simuladas
stats_sim <- data.frame(
  Distribución = c("Geométrica (r=1)", "Binomial Neg. (r=3)"),
  Media_Simulada = c(mean(geometrica_sim), mean(binneg_sim)),
  Media_Teórica = c(1 * (1-p_sim)/p_sim, 3 * (1-p_sim)/p_sim),
  Var_Simulada = c(var(geometrica_sim), var(binneg_sim)),
  Var_Teórica = c(1 * (1-p_sim)/(p_sim^2), 3 * (1-p_sim)/(p_sim^2))
)

kable(stats_sim, digits = 3,
      caption = paste("Verificación por simulación (p =", p_sim, ", n =", 
                      format(n_sim_comp, big.mark = ","), ")"))
```

```{r histogramas-comparacion, fig.cap="Histogramas comparativos de las simulaciones"}
# Combinar datos para el gráfico
data_hist <- data.frame(
  valores = c(geometrica_sim, binneg_sim),
  distribucion = rep(c("Geométrica (r=1)", "Binomial Negativa (r=3)"), 
                     each = n_sim_comp)
)

# Histogramas comparativos
ggplot(data_hist, aes(x = valores, fill = distribucion)) +
  geom_histogram(alpha = 0.7, bins = 20, position = "identity") +
  facet_wrap(~distribucion, scales = "free") +
  labs(title = "Histogramas de las Simulaciones",
       subtitle = paste("p =", p_sim, ", n =", format(n_sim_comp, big.mark = ",")),
       x = "Número de fracasos",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#3498DB", "#E67E22"))
```

## Aproximación con el Teorema Central del Límite

### Fundamento Teórico

Cuando $r$ es grande, la distribución binomial negativa se puede aproximar a una distribución normal:

$$X \sim \text{BinNeg}(r, p) \approx N\left(\mu = \frac{r(1-p)}{p}, \sigma^2 = \frac{r(1-p)}{p^2}\right)$$

### Demostración con Simulación

```{r tcl-demostracion, fig.cap="Aproximación normal para diferentes valores de r"}
# Parámetros para TCL
p_tcl <- 0.3
r_vals_tcl <- c(5, 10, 20, 50)
n_sim_tcl <- 5000

# Función para crear datos de comparación
crear_datos_tcl <- function(r_val, p_val, n_sim) {
  # Simulación
  sim_vals <- rnbinom(n_sim, size = r_val, prob = p_val)
  
  # Parámetros teóricos
  mu <- r_val * (1 - p_val) / p_val
  sigma2 <- r_val * (1 - p_val) / (p_val^2)
  sigma <- sqrt(sigma2)
  
  # Normalizar
  z_vals <- (sim_vals - mu) / sigma
  
  return(list(
    originales = sim_vals,
    normalizados = z_vals,
    mu = mu,
    sigma = sigma,
    r = r_val
  ))
}

# Generar datos para cada r
datos_tcl <- lapply(r_vals_tcl, crear_datos_tcl, p_val = p_tcl, n_sim = n_sim_tcl)

# Crear data frame para ggplot
data_tcl <- do.call(rbind, lapply(1:length(datos_tcl), function(i) {
  data.frame(
    valores_norm = datos_tcl[[i]]$normalizados,
    r_valor = paste("r =", datos_tcl[[i]]$r)
  )
}))

# Gráfico de densidad con aproximación normal
ggplot(data_tcl, aes(x = valores_norm)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.6, bins = 30, fill = "#3498DB") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "#E74C3C", linewidth = 1.2, linetype = "dashed") +
  facet_wrap(~r_valor, scales = "free") +
  labs(title = "Aproximación Normal (Teorema Central del Límite)",
       subtitle = paste("Valores normalizados, p =", p_tcl, 
                       ". Línea roja: N(0,1)"),
       x = "Valores normalizados (Z)",
       y = "Densidad") +
  theme_minimal()
```



## Relación con la Suma de Variables Geométricas


:::{#prp-binneg_geo}

Si $X_1, X_2, \ldots, X_r$ son variables aleatorias independientes e idénticamente distribuidas con distribución geométrica de parámetro $p$ (número de fracasos antes del primer éxito), entonces:

$$Y = X_1 + X_2 + \cdots + X_r \sim \text{BinNeg}(r, p)$$

Es decir, la suma de $r$ variables aleatorias geométricas independientes sigue una distribución binomial negativa con parámetros $r$ y $p$.

:::

**Justificación intuitiva**

- Cada $X_i$ cuenta los fracasos antes del $i$-ésimo éxito
- $Y = \sum_{i=1}^r X_i$ cuenta el total de fracasos antes de obtener $r$ éxitos
- Esto es exactamente lo que modela la distribución binomial negativa


### Verificación por Simulación



```{r simulacion-proposicion}
# Parámetros
r <- 4
p <- 0.3
n_sim <- 10000

set.seed(42)

# Método 1: Generar r variables geométricas y sumarlas
suma_geometricas <- replicate(n_sim, {
  geometricas <- rgeom(r, prob = p)  # rgeom en R usa la definición estándar
  sum(geometricas)
})

# Método 2: Generar directamente de binomial negativa
binomial_negativa <- rnbinom(n_sim, size = r, prob = p)

# Comparar estadísticas
stats_comparacion <- data.frame(
  Método = c("Suma de Geométricas", "Binomial Negativa Directa"),
  Media = c(mean(suma_geometricas), mean(binomial_negativa)),
  Varianza = c(var(suma_geometricas), var(binomial_negativa)),
  Desv_Std = c(sd(suma_geometricas), sd(binomial_negativa)),
  Min = c(min(suma_geometricas), min(binomial_negativa)),
  Max = c(max(suma_geometricas), max(binomial_negativa))
)

# Valores teóricos
media_teorica <- r * (1 - p) / p
var_teorica <- r * (1 - p) / (p^2)

stats_comparacion$Dif_Media_Teorica <- abs(stats_comparacion$Media - media_teorica)
stats_comparacion$Dif_Var_Teorica <- abs(stats_comparacion$Varianza - var_teorica)

kable(stats_comparacion, digits = 4,
      caption = paste("Verificación de la proposición (r =", r, ", p =", p, ")"))

cat("Valores teóricos:\n")
cat("Media:", round(media_teorica, 4), "\n")
cat("Varianza:", round(var_teorica, 4), "\n")
```



```{r comparacion-distribuciones, fig.cap="Comparación de histogramas: Suma de geométricas vs Binomial negativa"}
# Crear data frame para comparación
data_comparacion <- data.frame(
  valores = c(suma_geometricas, binomial_negativa),
  metodo = rep(c("Suma de r=4 Geométricas", "Binomial Negativa (r=4)"), 
               each = n_sim)
)

# Histogramas comparativos
ggplot(data_comparacion, aes(x = valores, fill = metodo)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  facet_wrap(~metodo, ncol = 1) +
  labs(title = "Verificación de la Proposición: Suma de Geométricas = Binomial Negativa",
       subtitle = paste("r =", r, ", p =", p, ", n =", format(n_sim, big.mark = ",")),
       x = "Número de fracasos",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#3498DB", "#E74C3C"))
```


## Ejemplos Prácticos

::: {#exm-calidadbinneg}

### Control de Calidad en Producción

**Situación:** Una fábrica produce componentes electrónicos. La probabilidad de que un componente sea defectuoso es $p = 0.15$. Un inspector necesita encontrar 3 componentes buenos para completar un lote.

**Pregunta:** ¿Cuál es la probabilidad de que el inspector examine exactamente 8 componentes defectuosos antes de encontrar los 3 buenos?

```{r ejemplo-calidad}
# Parámetros del problema
p_bueno <- 0.85  # Probabilidad de componente bueno
r_buenos <- 3    # Componentes buenos necesarios
k_defectuosos <- 8  # Componentes defectuosos observados

# Método 1: Usando binomial negativa directamente
prob_binneg <- dnbinom(k_defectuosos, size = r_buenos, prob = p_bueno)

# Método 2: Simulación como suma de geométricas
# Cada geométrica cuenta defectuosos antes de cada componente bueno
n_sim_ej1 <- 100000
suma_defectuosos <- replicate(n_sim_ej1, {
  sum(rgeom(r_buenos, prob = p_bueno))
})

prob_simulada <- mean(suma_defectuosos == k_defectuosos)

cat("EJEMPLO 1: Control de Calidad\n")
cat("=============================\n")
cat("Probabilidad (fórmula):", round(prob_binneg, 6), "\n")
cat("Probabilidad (simulación):", round(prob_simulada, 6), "\n")
cat("Diferencia:", abs(prob_binneg - prob_simulada), "\n\n")

# Interpretación práctica
cat("Interpretación: La probabilidad de examinar exactamente 8 componentes\n")
cat("defectuosos antes de encontrar 3 buenos es aproximadamente", 
    round(prob_binneg * 100, 2), "%\n")
```


:::


::: {#exm-ventas_prosp}



**Situación:** Un vendedor tiene una tasa de éxito del 25% en sus presentaciones. Necesita cerrar 5 ventas para cumplir su meta mensual.

**Preguntas:**
1. ¿Cuál es el número esperado de rechazos antes de cerrar 5 ventas?
2. ¿Cuál es la probabilidad de tener entre 10 y 15 rechazos?

```{r ejemplo-ventas}
# Parámetros
p_exito <- 0.25
r_ventas <- 5

# 1. Número esperado de rechazos
rechazos_esperados <- r_ventas * (1 - p_exito) / p_exito
desv_std_rechazos <- sqrt(r_ventas * (1 - p_exito) / (p_exito^2))

# 2. Probabilidad entre 10 y 15 rechazos
prob_10_15 <- sum(dnbinom(10:15, size = r_ventas, prob = p_exito))

# Simulación para verificar
n_sim_ej2 <- 50000
simulacion_ventas <- replicate(n_sim_ej2, {
  sum(rgeom(r_ventas, prob = p_exito))
})

rechazos_sim_esperados <- mean(simulacion_ventas)
prob_10_15_sim <- mean(simulacion_ventas >= 10 & simulacion_ventas <= 15)

cat("EJEMPLO 2: Ventas y Prospección\n")
cat("================================\n")
cat("1. Rechazos esperados:\n")
cat("   Teórico:", round(rechazos_esperados, 2), "±", round(desv_std_rechazos, 2), "\n")
cat("   Simulación:", round(rechazos_sim_esperados, 2), "\n\n")

cat("2. P(10 ≤ rechazos ≤ 15):\n")
cat("   Teórico:", round(prob_10_15, 4), "\n")
cat("   Simulación:", round(prob_10_15_sim, 4), "\n")
```


:::



::: {#exm-algoritmo}

**Situación:** Un algoritmo de machine learning busca patrones específicos en datos. La probabilidad de encontrar un patrón válido es 0.4. El algoritmo necesita encontrar 6 patrones para entrenar el modelo.

```{r ejemplo-ml, fig.cap="Distribución de iteraciones fallidas en machine learning"}
# Parámetros
p_patron <- 0.4
r_patrones <- 6

# Simulación del proceso
n_experimentos <- 10000
iteraciones_fallidas <- replicate(n_experimentos, {
  sum(rgeom(r_patrones, prob = p_patron))
})

# Estadísticas
media_iteraciones <- mean(iteraciones_fallidas)
percentiles <- quantile(iteraciones_fallidas, probs = c(0.25, 0.5, 0.75, 0.9, 0.95))

cat("EJEMPLO 3: Machine Learning\n")
cat("===========================\n")
cat("Iteraciones fallidas esperadas:", round(media_iteraciones, 1), "\n")
cat("Percentiles:\n")
print(round(percentiles, 1))

# Gráfico de la distribución
ggplot(data.frame(iteraciones = iteraciones_fallidas), aes(x = iteraciones)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "#3498DB", alpha = 0.7) +
  geom_vline(xintercept = media_iteraciones, color = "#E74C3C", 
             linetype = "dashed", linewidth = 1) +
  labs(title = "Distribución de Iteraciones Fallidas en ML",
       subtitle = paste("p =", p_patron, ", r =", r_patrones, 
                       ". Línea roja: media =", round(media_iteraciones, 1)),
       x = "Número de iteraciones fallidas",
       y = "Densidad") +
  theme_minimal()
```

:::

## Ejercicios Propuestos





::: {#exr-grafico}

Implemente una función que tome como parámetros $(r, p, n_{sim})$ y devuelva un gráfico comparativo entre la suma de geométricas y la binomial negativa.
```{r}

comparar_geometrica_binomial_negativa <- function(r, p, msim = 10000) {
  
  
  if (r <= 0 | p <= 0 | p > 1) {
    stop("Parámetros inválidos: r debe ser > 0 y 0 < p ≤ 1")
  }
  
  
  suma_geometricas <- replicate(msim, {
    # Generar r variables geométricas (cada una cuenta fracasos antes de un éxito)
    geometricas <- rgeom(r, prob = p)
    # Sumar los fracasos totales antes del r-ésimo éxito
    sum(geometricas)
  })
  
  
 
  k_max <- max(suma_geometricas)
  k_vals <- 0:k_max
  prob_binneg <- dnbinom(k_vals, size = r, prob = p)
  
  
  prob_binneg <- prob_binneg / sum(prob_binneg)
  
  
  freq_obs <- table(factor(suma_geometricas, levels = k_vals)) / msim
  
  
  df_comparacion <- data.frame(
    k = rep(k_vals, 2),
    Probabilidad = c(prob_binneg, as.numeric(freq_obs)),
    Tipo = rep(c("Binomial Negativa (Teórica)", "Suma de Geométricas (Observada)"), 
               each = length(k_vals))
  )
  
 
  media_obs <- mean(suma_geometricas)
  media_teo <- r * (1 - p) / p  # Media teórica de Binomial Negativa
  
  var_obs <- var(suma_geometricas)
  var_teo <- r * (1 - p) / (p^2)  # Varianza teórica de Binomial Negativa
  
 
  library(ggplot2)
  grafico <- ggplot(df_comparacion, aes(x = k, y = Probabilidad, fill = Tipo)) +
    geom_bar(stat = "identity", position = "dodge", alpha = 0.7, width = 0.7) +
    labs(
      title = paste("Comparación: Suma de", r, "Geométricas vs Binomial Negativa"),
      subtitle = paste("Parámetros: r =", r, ", p =", p, "| Simulaciones:", msim),
      x = "Número de fracasos (k)",
      y = "Probabilidad",
      fill = "Distribución"
    ) +
    theme_minimal() +
    scale_fill_manual(values = c("Binomial Negativa (Teórica)" = "#E74C3C", 
                                 "Suma de Geométricas (Observada)" = "#3498DB")) +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = min(15, length(k_vals))))
  
  
  cat("=== COMPARACIÓN ESTADÍSTICA ===\n")
  cat("Parámetros: r =", r, ", p =", p, "\n")
  cat("Media observada (suma geométricas):", round(media_obs, 4), "\n")
  cat("Media teórica (binomial negativa):", round(media_teo, 4), "\n")
  cat("Varianza observada:", round(var_obs, 4), "\n")
  cat("Varianza teórica:", round(var_teo, 4), "\n")
  cat("Diferencia en medias:", round(abs(media_obs - media_teo), 6), "\n\n")
  
  
  frec_obs_ajust <- as.numeric(table(factor(suma_geometricas, levels = k_vals)))
  
 
  n_categories <- length(frec_obs_ajust)
  prob_teo_ajust <- prob_binneg[1:n_categories]
  
  
  chi_test <- chisq.test(frec_obs_ajust, p = prob_teo_ajust)
  
  cat("PRUEBA DE BONDAD DE AJUSTE (Chi-cuadrado):\n")
  cat("Estadístico:", round(chi_test$statistic, 4), "\n")
  cat("Valor p:", round(chi_test$p.value, 4), "\n")
  
  if(chi_test$p.value > 0.05) {
    cat("CONCLUSIÓN: No se rechaza H0 - Las distribuciones son consistentes ✓\n")
  } else {
    cat("CONCLUSIÓN: Se rechaza H0 - Las distribuciones NO son consistentes\n")
  }
  
  return(grafico)
}



# Ejemplo 1: Parámetros del problema de control de calidad
cat("=== EJEMPLO 1: CONTROL DE CALIDAD ===\n")
grafico1 <- comparar_geometrica_binomial_negativa(r = 3, p = 0.85, msim = 10000)
print(grafico1)

# Ejemplo 2: Otros parámetros
cat("\n=== EJEMPLO 2: DIFERENTES PARÁMETROS ===\n")
grafico2 <- comparar_geometrica_binomial_negativa(r = 4, p = 0.3, msim = 10000)
print(grafico2)

# Ejemplo 3: Más éxitos requeridos
cat("\n=== EJEMPLO 3: MÁS ÉXITOS REQUERIDOS ===\n")
grafico3 <- comparar_geometrica_binomial_negativa(r = 6, p = 0.5, msim = 10000)
print(grafico3)


calcular_probabilidad <- function(r, p, k) {
  
  prob_teorica <- dnbinom(k, size = r, prob = p)
  
 
  msim <- 100000
  suma_sim <- replicate(msim, sum(rgeom(r, prob = p)))
  prob_simulada <- mean(suma_sim == k)
  
  cat("\n=== CÁLCULO DE PROBABILIDAD ESPECÍFICA ===\n")
  cat("Parámetros: r =", r, ", p =", p, ", k =", k, "\n")
  cat("Probabilidad de exactamente", k, "fracasos antes del", r, "º éxito:\n")
  cat("• Binomial Negativa (teórica):", round(prob_teorica, 6), "\n")
  cat("• Suma de Geométricas (simulada):", round(prob_simulada, 6), "\n")
  cat("• Diferencia:", round(abs(prob_teorica - prob_simulada), 6), "\n")
  
  return(data.frame(
    Metodo = c("Binomial Negativa", "Suma Geométricas"),
    Probabilidad = c(prob_teorica, prob_simulada)
  ))
}


prob_resultados <- calcular_probabilidad(r = 3, p = 0.85, k = 8)


cat("\n=== VERIFICACIONES ADICIONALES ===\n")
calcular_probabilidad(r = 2, p = 0.5, k = 3)
calcular_probabilidad(r = 5, p = 0.2, k = 10)
```

:::

::: {#exr-baloncesto}

Un jugador de baloncesto tiene 70% de efectividad en tiros libres. En una sesión de entrenamiento quiere anotar 8 tiros libres consecutivos exitosos.

a) Modele el problema usando la proposición de suma de geométricas
b) Calcule el número esperado de tiros fallados
c) Simule 1000 sesiones de entrenamiento y compare con el valor teórico
```{r}
# EJERCICIO: Jugador de baloncesto - Binomial Negativa
set.seed(123)


p_exito <- 0.70      # Probabilidad de éxito en cada tiro
r_exitos <- 8        # Número de éxitos consecutivos deseados
n_sim <- 1000        # Número de simulaciones

cat("=== JUGADOR DE BALONCESTO - TIROS LIBRES ===\n")
cat("Parámetros: p =", p_exito, ", r =", r_exitos, "\n\n")


cat("a) MODELADO CON SUMA DE GEOMÉTRICAS:\n")
cat("   Sea X_i ~ Geom(p = 0.7) para i = 1,2,...,8\n")
cat("   Donde cada X_i representa los fallos antes del i-ésimo éxito\n")
cat("   Entonces, el total de fallos antes de 8 éxitos es: S = X₁ + X₂ + ... + X₈\n")
cat("   Y S ~ BinNeg(r = 8, p = 0.7)\n\n")


cat("b) CÁLCULO DEL NÚMERO ESPERADO DE TIROS FALLADOS:\n")


fallos_esperados_teo <- r_exitos * (1 - p_exito) / p_exito
varianza_teo <- r_exitos * (1 - p_exito) / (p_exito^2)
desviacion_teo <- sqrt(varianza_teo)

cat("   Número esperado de fallos (teórico):", round(fallos_esperados_teo, 4), "\n")
cat("   Desviación estándar teórica:", round(desviacion_teo, 4), "\n")


tiros_totales_esperados <- r_exitos + fallos_esperados_teo
cat("   Número total esperado de tiros:", round(tiros_totales_esperados, 4), "\n\n")


cat("c) SIMULACIÓN DE", n_sim, "SESIONES DE ENTRENAMIENTO:\n")


simulacion_fallos <- replicate(n_sim, {
 
  fallos_por_exito <- rgeom(r_exitos, prob = p_exito)
  
  sum(fallos_por_exito)
})


fallos_esperados_sim <- mean(simulacion_fallos)
varianza_sim <- var(simulacion_fallos)
desviacion_sim <- sd(simulacion_fallos)

cat("   Resultados de la simulación:\n")
cat("   - Fallos promedio observados:", round(fallos_esperados_sim, 4), "\n")
cat("   - Desviación estándar observada:", round(desviacion_sim, 4), "\n")
cat("   - Diferencia con valor teórico:", round(abs(fallos_esperados_sim - fallos_esperados_teo), 6), "\n")


tiros_totales_sim <- simulacion_fallos + r_exitos
cat("   - Tiros totales promedio:", round(mean(tiros_totales_sim), 4), "\n\n")


library(ggplot2)


k_max <- max(simulacion_fallos)
k_vals <- 0:k_max


prob_teorica <- dnbinom(k_vals, size = r_exitos, prob = p_exito)


freq_obs <- table(factor(simulacion_fallos, levels = k_vals)) / n_sim

df_comparacion <- data.frame(
  k = rep(k_vals, 2),
  Probabilidad = c(prob_teorica, as.numeric(freq_obs)),
  Tipo = rep(c("Teórica (Bin Neg)", "Observada (Simulación)"), each = length(k_vals))
)


grafico <- ggplot(df_comparacion, aes(x = k, y = Probabilidad, fill = Tipo)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7, width = 0.7) +
  labs(
    title = "Distribución de Fallos antes de 8 Éxitos Consecutivos",
    subtitle = paste("Jugador de baloncesto (p =", p_exito, ", r =", r_exitos, ")"),
    x = "Número de tiros fallados",
    y = "Probabilidad / Frecuencia",
    fill = "Distribución"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Teórica (Bin Neg)" = "#E74C3C", 
                               "Observada (Simulación)" = "#3498DB")) +
  theme(
    legend.position = "top",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

print(grafico)


cat("=== ANÁLISIS ADICIONAL ===\n")


prob_3_fallos_teo <- dnbinom(3, size = r_exitos, prob = p_exito)
prob_3_fallos_sim <- mean(simulacion_fallos == 3)
cat("Probabilidad de exactamente 3 fallos:\n")
cat("   Teórica:", round(prob_3_fallos_teo, 4), "\n")
cat("   Simulada:", round(prob_3_fallos_sim, 4), "\n")


prob_menos_5_teo <- pnbinom(4, size = r_exitos, prob = p_exito)
prob_menos_5_sim <- mean(simulacion_fallos <= 4)
cat("\nProbabilidad de menos de 5 fallos:\n")
cat("   Teórica:", round(prob_menos_5_teo, 4), "\n")
cat("   Simulada:", round(prob_menos_5_sim, 4), "\n")


cat("\n=== RESUMEN DE LA SIMULACIÓN ===\n")
cat("Mínimo de fallos observados:", min(simulacion_fallos), "\n")
cat("Máximo de fallos observados:", max(simulacion_fallos), "\n")
cat("Mediana de fallos observados:", median(simulacion_fallos), "\n")


percentiles <- quantile(simulacion_fallos, probs = c(0.25, 0.75))
cat("Primer cuartil (Q1):", percentiles[1], "\n")
cat("Tercer cuartil (Q3):", percentiles[2], "\n")


frec_obs_ajust <- as.numeric(table(factor(simulacion_fallos, levels = k_vals)))
prob_teo_ajust <- prob_teorica / sum(prob_teorica)  # Normalizar

chi_test <- chisq.test(frec_obs_ajust, p = prob_teo_ajust)

cat("\nPRUEBA DE BONDAD DE AJUSTE:\n")
cat("Estadístico chi-cuadrado:", round(chi_test$statistic, 4), "\n")
cat("Valor p:", round(chi_test$p.value, 4), "\n")

if(chi_test$p.value > 0.05) {
  cat("CONCLUSIÓN: La simulación es consistente con la distribución teórica ✓\n")
} else {
  cat("CONCLUSIÓN: La simulación NO es consistente con la distribución teórica\n")
}
```


:::


::: {#exr-biotecnologia}

Un laboratorio está desarrollando un nuevo medicamento. Las pruebas tienen 30% de probabilidad de ser exitosas. Necesitan 4 pruebas exitosas para continuar con la siguiente fase.

a) ¿Cuál es la probabilidad de tener exactamente 12 pruebas fallidas?
b) ¿Cuál es la probabilidad de necesitar más de 20 pruebas fallidas?
c) Si el costo de cada prueba es $10,000, ¿cuál es el costo esperado en pruebas fallidas?

:::
```{r}
p_exito <- 0.3        # Probabilidad de que una prueba sea exitosa
r_exitos <- 5         # Número de pruebas exitosas requeridas
n_sim <- 10000        # Número de simulaciones



pruebas_fallidas <- replicate(n_sim, {
    sum(rgeom(r_exitos, prob = p_exito))
})


media_fallidas <- mean(pruebas_fallidas)
percentiles <- quantile(pruebas_fallidas, probs = c(0.25, 0.5, 0.75, 0.9, 0.95))

cat("Parámetros del problema:\n")
cat("- Probabilidad de prueba exitosa: p =", p_exito, "\n")
cat("- Pruebas exitosas requeridas: r =", r_exitos, "\n")
cat("- Simulaciones: n =", n_sim, "\n\n")

cat("RESULTADOS DE LA SIMULACIÓN:\n")
cat("Pruebas fallidas esperadas:", round(media_fallidas, 1), "\n\n")


fallidas_teoricas <- r_exitos * (1 - p_exito) / p_exito
cat("COMPARACIÓN CON VALOR TEÓRICO:\n")
cat("Pruebas fallidas teóricas:", round(fallidas_teoricas, 1), "\n")
cat("Diferencia:", round(abs(media_fallidas - fallidas_teoricas), 4), "\n\n")

cat("DISTRIBUCIÓN DE PRUEBAS FALLIDAS:\n")
cat("Percentil 25%:", percentiles[1], "\n")
cat("Mediana (50%):", percentiles[2], "\n")
cat("Percentil 75%:", percentiles[3], "\n")
cat("Percentil 90%:", percentiles[4], "\n")
cat("Percentil 95%:", percentiles[5], "\n\n")


cat("ANÁLISIS ADICIONAL:\n")
prob_mas_10_fallidas <- mean(pruebas_fallidas > 10)
prob_menos_5_fallidas <- mean(pruebas_fallidas < 5)

cat("Probabilidad de más de 10 pruebas fallidas:", round(prob_mas_10_fallidas, 4), "\n")
cat("Probabilidad de menos de 5 pruebas fallidas:", round(prob_menos_5_fallidas, 4), "\n")


cat("\nVERIFICACIÓN CON DISTRIBUCIÓN BINOMIAL NEGATIVA:\n")
prob_teorica_mas_10 <- 1 - pnbinom(10, size = r_exitos, prob = p_exito)
prob_teorica_menos_5 <- pnbinom(4, size = r_exitos, prob = p_exito)

cat("Probabilidad teórica >10 fallidas:", round(prob_teorica_mas_10, 4), "\n")
cat("Probabilidad teórica <5 fallidas:", round(prob_teorica_menos_5, 4), "\n")

cat("\n================================================\n")
```

